<head>
	<script type="text/javascript">
		var djConfig = {
			isDebug: false,
			parseOnLoad: true,
			baseUrl: './',
			modulePaths: { 'unc': 'unc'  }
		};
	</script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.5/dojo/dojo.xd.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
	<script src="raphael.js"></script>
	<script type="text/javascript" src="/libs/uow.js"></script>
	<script src="crevasseintegrateme.js"></script>
	<script src="random.js"></script>
	<script>
		dojo.require("dojo.window");
		
		function go(){
			g = new game();
			uow.getAudio().then(function(js){
				g.noise = js;
				g.title();
			});
		}
		
		dojo.declare("game", null, {
			constructor: function(args){  //will have a team object, visuals object, and eventbox
				dojo.mixin(this, args);
				this.vis = new visuals({game: this});
				this.team = new team({game: this});
				this.eventbox = new eventbox({game: this});
				this.days = 0;
				this.weapons = 0;
				this.dogs = 0;
				this.food = 0;
				this.blankets = 0;
				this.weight = 0;
				this.speed = 0;
				this.money = 3000;
				this.miles = 0;
				this.playing = true;
				this.q = [];
				this.steppable = true;
			},
			title: function(){
				this.state = 'title';
				this.vis.setup();
				this.team.setup();
				this.vis.title();
			},
			start: function(){
				if (this.state == 'title'){
					this.vis.intro();
					this.state = 'intro';
				}
			},
			chooseteam: function(){
				if (this.state == 'intro'){
					this.vis.chooseteam();
					this.state = 'chooseteam';
				}
			},
			supplies: function(){
				if (this.state == 'chooseteam'){
					this.eventbox.setup();
					this.vis.supplies();
					this.state = 'supplies';
				}
			},
			startJourney: function(){
				if (this.playing){
					this.vis.startJourney();
				}
			},
			step: function(){
				console.log('step was called', g.playing);
				this.steppable = false;
				setTimeout(function(){
					this.steppable = true;
				}, 300);
				dojo.forEach(g.team.members, function(m){
					m.updatestat();
				});
				if (g.playing){
					if (this.q.length > 0){
						var f = this.q.shift();
						f.die();
					}
					else{
						this.team.makeVictim();
						this.vis.cleartemp();
						this.calcspeed();
						var h = this.eventbox.getNext();
						console.log(h);
						h.occur();
						this.managefood();
						this.checkwin();
						this.sidebar.update();
					}
				}
			},
			calcspeed: function(){
				var dogfactor = 100*this.dogs/(this.weight+500);
				var personfactor = this.team.getspeedfactor();
				this.speed = Math.floor(10*dogfactor*personfactor)+1;
				this.eatfactor = Math.floor((this.team.alive*2 + this.dogs)/2);
			},
			managefood: function(){
				this.food = Math.floor(this.food);
				this.miles = Math.floor(this.miles);
				if (this.food <= 0){
					this.food = 0;
					this.team.starve();
				}
			},
			checkwin: function(){
				if (this.miles > 400){
					this.vis.win();
					this.playing = false;
				}
			},
			lose: function(){
				this.vis.lose();
				this.playing = false;
			},
			changesupplies: function( type, change ){
				if (type == 'food'){
					this.food = this.food + change;
				}
				if (type == 'blankets'){
					this.blankets = this.blankets + change;
				}
				if (type == 'weapons'){
					this.weapons = this.weapons + change;
				}
				if (type == 'dogs'){
					this.dogs = this.dogs + change;
				}
				this.weight = this.food + this.blankets*10 + this.weapons*30;
				this.sidebar.update();
			}
		});
		
		
		dojo.declare("visuals", null, {
			constructor: function(args){
				dojo.mixin(this, args);
			},
			setup: function(){
				this.temp = [];
			
				this.k = {}; // k is for constants
				this.k.w = dojo.window.getBox().w;
				this.k.h = dojo.window.getBox().h;
				this.k.big = this.k.w/25;
				this.k.med = this.k.big/2;
				this.k.small = this.k.med/2;
				this.k.nextx = this.k.w*.9;
				this.k.nexty = this.k.h*.9;
				this.k.sidebarw = this.k.w*.2;
				this.nameImages();
				this.messages();
				
				this.r = new Raphael(0,0,this.k.w, this.k.h);
			},
			nameImages: function(){
				this.im = {};
				this.im.title = "titlepic.jpg"; //jan_krutisch on flickr
				this.im.intro = "introSTANDIN.jpg";
				this.im.teamchoose = "teamchooseSTANDIN.jpg";
				this.im.supplies = "suppliesSTANDIN.jpg";
				this.im.journeystart = "journeystartSTANDIN.jpg";					
			},
			messages: function(){
				var mess = {};
				mess.title = "Epic Journey";
				mess.intro = "You are now making your mark and\n"+ 
							 "re-writing history in the Heroic Age\n"+
							 "of Antarctic Exploration era. Resources\n"+ 
							 "will be scarce, the journey will be \n"+
							 "long, and your team will struggle… but\n" +
							 "will you overcome adversity and become\n"+
							 "a hero?";
				mess.start = "Your team sets off across Antractica!\n"+
							 "Your team's spirits are really high, and\n"+
							 "everyone is talking about how they will\n"+
							 "leave their mark at the pole!";
				this.mess = mess;
			},
			title: function(){
				this.back = this.r.image(this.im.title, 0,0,this.k.w, this.k.h);
				this.border = this.r.rect(0,0,this.k.w, this.k.h).attr({'stroke-width':this.k.small}).attr({opacity:.6});
				this.tbutton( this.k.w/2, this.k.h*.8, "Click to play", this.k.big, this.r, dojo.hitch(this.game,this.game.start) );
				this.tbutton( this.k.w/2, this.k.h*.3, this.mess.title, this.k.big*2, this.r, dojo.hitch(this.game,this.game.start) );
			},
			intro: function(){
				this.cleartemp();
				this.changeback(this.im.intro);
				this.next = new button({det:'text', x:this.k.nextx, y:this.k.nexty, t:' next ', s:this.k.big, f:dojo.hitch(this.game, this.game.chooseteam), r:this.r});
				this.central(this.mess.intro);
			},
			chooseteam: function(){
				this.cleartemp();
				this.changeback(this.im.teamchoose);
				this.next.hide();
				this.sidebar();
				this.header('Choose Four People');
				var num = 4;
				var teambuttony = this.k.big*4;
				var teambuttonheight = (this.k.h - this.k.small - teambuttony + this.k.med)/4 - this.k.med;
				var teambuttonwidth = (this.k.w*.2);
				var teambuttonx = this.k.sidebarw+this.k.med;
				
				var infox = teambuttonx+teambuttonwidth+this.k.small;
				var infoy = teambuttony;
				var infow = this.k.w - this.k.small - infox;
				var infoh = this.k.h - this.k.small - infoy;
				
				
				var self = this;
				self.infobox = self.sbutton(infox, infoy, self.game.team.poss[0].text, infow, infoh, self.r, function(){self.game.team.add(self.game.team.poss[0]);});
				function select(person){
					dojo.forEach(teambuttons, function(b){
						b.back.attr({fill:'#fff'});
					});
					self.infobox.remove();
					self.infobox = self.sbutton(infox, infoy, person.text, infow, infoh, self.r, function(){self.game.team.add(person);});
				}
				
				var i = 0;
				var teambuttons = [];
				var minfont = 1000000;
				dojo.forEach( this.game.team.poss, dojo.hitch(this, function(person){
					var b = this.sbutton(teambuttonx, 
								 teambuttony+(teambuttonheight+this.k.med)*i, 
								 this.game.team.poss[i].type, 
								 teambuttonwidth, 
								 teambuttonheight, 
								 this.r, 
								 function(){
									select(person);
								}
					);
					b.setf(function(){
						select(person);
						b.back.attr({fill:'#0f0'});
					});
					if (b.size < minfont){
						minfont = b.size;
					}
					teambuttons.push(b);
					i = i +1;
				}));
				teambuttons[0].back.attr({fill:"#0f0"});
				dojo.forEach(teambuttons, function(b){
					b.text.attr({font:minfont+'px Arial'});
				});
			},
			supplies: function(){
				this.cleartemp();
				var self = this;
				this.changeback(this.im.supplies);
				this.next.show();
				self.next.clickable = true;
				this.next.setf(function(){
					if (self.next.clickable){
						self.next.clickable = false;
						self.game.startJourney();
						setTimeout( function(){
							self.next.clickable = true;
						}, 300);
					}
				});
				this.header('Buy Supplies');
				this.sidebar.supplies();
				var bx = this.k.sidebarw+this.k.med;
				var by = this.k.big*4;
				var bw = (this.k.w - bx - this.k.small*2 - this.k.med)/2;
				var bh = (this.k.nexty - by - this.k.small - this.k.med*2 - this.k.big)/2;
				var minfont = 1000000;
				var moneyout = this.tbutton( this.k.w/2+this.k.sidebarw/2, this.k.nexty, 'Money: $'+this.game.money, this.k.big, this.r, function(){});	
				function updateMoney(dmoney){
					self.game.money = self.game.money - dmoney;
					moneyout.text.attr({text:"Money: $"+self.game.money});
				}
				var one = this.sbutton(bx, by, 'BUY 3 DAY\'S FOOD\n'+
											   'weight: 15 lbs\n'+
											   'price: $50', bw, bh, self.r, function(){
					if (self.game.money >= 50){
						self.game.changesupplies( 'food' , 15 );
						updateMoney(50);
					}
				});
				var two = this.sbutton(bx + bw + this.k.small, by, 'BUY 1 WEAPON\n'+
																   'weight: 20 lbs\n'+
																   'price: $200', bw, bh, self.r, function(){
					if (self.game.money >= 200){
						self.game.changesupplies( 'weapons' , 1 );
						updateMoney(200);
					}
				});
				var three = this.sbutton(bx, by+ bh + this.k.small, 'BUY 1 BLANKET\n'+
																	'weight: 10 lbs\n'+
																	'price: $50', bw, bh, self.r, function(){
					if (self.game.money >= 50){
						self.game.changesupplies( 'blankets' , 1 );
						updateMoney(50);
					}
				});
				var four = this.sbutton(bx+ bw + this.k.small, by+ bh + this.k.small, 'BUY 1 DOG\n'+
																					  'weight: N/A\n'+
																					  'price: $400', bw, bh, self.r, function(){
					if (self.game.money >= 400){
						self.game.changesupplies( 'dogs' , 1 );
						updateMoney(400);
					}
				});
				dojo.forEach( [one, two, three, four], function(e){
					if (minfont > e.size){
						minfont = e.size;
					}
				});
				dojo.forEach( [one, two, three, four], function(e){
					e.text.attr({font:minfont+'px Arial'});
				});			
			},
			startJourney: function(){
				var self = this;
				this.cleartemp();
				this.sidebar.journey();
				this.changeback(this.im.journeystart);
				this.central(this.mess.start);
				this.next.clickable = true;
				this.next.setf(function(){
					self.game.step();
				});
			},
			displaynormal: function(message, im){
				this.next.show();
				this.cleartemp();
				this.central(message);
				this.changeback(im);
			},
			displaycomplex: function(message, im, choices){
				this.cleartemp();
				this.next.hide();
				this.tbutton(this.k.w/2+this.k.sidebarw/2, this.k.h*.3, message, this.k.med, this.r, function(){});
				this.changeback(im);
				var cx = this.k.w/2 + this.k.sidebarw/2;
				var csize = this.k.med;
				var cy = this.k.h*.7 - choices.length*(csize+this.k.small)/2;
				var self = this;
				dojo.forEach(choices, function(c){
					if (c.canhappen()){
						self.tbutton(cx, cy, c.message, csize, self.r, dojo.hitch(c, c.pick));
						cy = cy + (self.k.small+csize*2)
					}
				});
			},
			win: function(){
				this.cleartemp();
				var score = g.team.alive*101+g.food+g.dogs*43;
				this.central("You have conquered the unforgiving Antarctic and completed\n"+
							 "your journey to the South Pole and back with " + g.team.alive+" people\n"+ 
							 "left on your team, "+g.food+" food supply, and "+g.dogs+" sled dogs. \n"+
							 "Congratulations! You have earned a score of "+score+".");
				this.next.hide();
				this.next.clickable = false;
			},
			lose: function(){
				this.cleartemp();
				this.central("It is not easy to become a hero in history. \n"+
							 "Rather than follow in Roald Amundsen’s footsteps,\n"+
							 "you have suffered the same ultimate fate that \n"+
							 "Robert Falcon Scott and his party suffered. Your\n"+
							 "team has perished.");
				this.next.hide();
				this.next.clickable = false;
			},
			sidebar: function(){
				this.sidebar = new sidebar({x:0, y:0, w:this.k.sidebarw, h:this.k.h, r:this.r});
				this.game.team.sidebar = this.sidebar;
				this.game.sidebar = this.sidebar;
				this.sidebar.team = this.game.team;
				this.sidebar.game = this.game;
			},
			header: function(text){
				var usefulw = this.k.w/2;
				if ('sidebar' in this){
					var usefulw = usefulw + this.k.sidebarw*.5;
				}
				var head = this.tbutton(usefulw, this.k.h*.08, text, this.k.big*1.3, this.r, function(){});
				this.temp.push(head);
			},
			central: function(text){
				if ("sidebar" in this){
					var a = this.sbutton(this.k.big*2+this.k.sidebarw, this.k.big*4, text, this.k.w - this.k.big*6 - this.k.sidebarw, this.k.h - this.k.big*8, this.r, function(){});
				}
				else{
					this.sbutton(this.k.big*4, this.k.big*4, text, this.k.w - this.k.big*8, this.k.h - this.k.big*8, this.r, function(){});
				}
				this.next.show();
				this.next.clickable = true;
			},
			changeback: function(imagename){
				var newback = this.r.image(imagename, 0,0,this.k.w, this.k.h);
				this.back.remove();
				this.back = newback;	
				this.back.toBack();
			},
			innerpic: function(imagename, x, y, w, h){
				var back = this.r.rect(x, y, w, h).attr({'stroke-width':w*.05, opacity:.7});
				var inner = this.r.image(imagename, x, y, w, h);
				this.temp.push(inner);
				this.temp.push(back);
			},
			tbutton: function(xpos,ypos,text,size,raph,func){ //button for which the size is based on the size of the text
				var b = new button({det: 'text', x:xpos, y:ypos, t:text, s:size, f:func, r:raph});
				this.temp.push(b);
				return b;
			},
			sbutton: function(xpos,ypos,text,width,height,raph,func){ //button for which the size of the text is limited by the size of the button
				var b = new button({det: 'size', x:xpos, y:ypos, t:text, w:width, h:height, f:func, r:raph});
				this.temp.push(b);
				return b
			},
			cleartemp: function(){
				dojo.forEach(this.temp, function(e){
					e.remove();
				});
			}
		});
		
		dojo.declare("sidebar", null, { 
		// 
		//  Team members
		//
		//	Name 1:
		//		Status
		//	Name 2:
		//		Status
		//	Name 3:
		//		Status
		//	Name 4:
		//		Status
		//
		//	*************
		//  *           *
		//  *    MAP    *
		//  *   HERE    *
		//  *           *
		//	*************
		//
			constructor: function(args){ //give me an x, y, w, h, raph.  I know what to display
				dojo.mixin(this, args);
				this.texto = 1;
				this.backo = .9;
				this.textsize = this.w/10;
				this.bordersize = this.w/14;
				this.mapx = this.bordersize;
				this.mapw = this.w - this.bordersize*2;
				this.maph = this.mapw;
				this.mapy = this.h-this.maph-this.bordersize;  //this needs to be changed
				this.make();
			},
			make: function(){
				this.back = this.r.rect(this.x, this.y, this.w, this.h).attr({'stroke-width':this.w*.03, fill:'#fff', opacity:this.backo});
				this.head = this.r.text(this.x+this.bordersize, this.bordersize*2, "Team members:").attr({font:this.textsize+'px Arial', 'text-anchor':'start'});
				this.persony = this.head.getBBox().height + this.bordersize*4;
				this.mapbox = this.r.rect(this.mapx, this.mapy, this.mapw, this.maph);
				this.map = this.r.text(this.mapx+this.mapw/2, this.mapy+this.maph/2, "MAP HERE").attr({font:this.textsize+'px Arial'});
				this.mapbox.attr({opacity: 0});
				this.map.attr({opacity: 0});
			},
			add: function(p){
				this.r.text(this.bordersize, this.persony, p.type+':').attr({font:this.textsize+'px Arial', 'text-anchor':'start'});
				p.statout = this.r.text(this.w - this.bordersize, this.persony, p.state).attr({font:this.textsize+'px Arial', 'text-anchor':'end'});
				this.persony = this.persony+this.textsize*1.3+this.bordersize;
			},
			supplies: function(){
				this.suppliesy = this.persony + this.textsize;
				
				//weight, food, blankets, dogs, weapons
				this.r.text(this.bordersize, this.suppliesy, 'Weight:').attr({font:this.textsize+'px Arial', 'text-anchor':'start'});
				this.weightout = this.r.text(this.w - this.bordersize, this.suppliesy, this.game.weight).attr({font:this.textsize+'px Arial', 'text-anchor':'end'});
				this.suppliesy = this.suppliesy+this.textsize*1.3+this.bordersize;
				
				this.r.text(this.bordersize, this.suppliesy, 'Food:').attr({font:this.textsize+'px Arial', 'text-anchor':'start'});
				this.foodout = this.r.text(this.w - this.bordersize, this.suppliesy, this.game.food).attr({font:this.textsize+'px Arial', 'text-anchor':'end'});
				this.suppliesy = this.suppliesy+this.textsize*1.3+this.bordersize;
				
				this.r.text(this.bordersize, this.suppliesy, 'Blankets:').attr({font:this.textsize+'px Arial', 'text-anchor':'start'});
				this.blanketsout = this.r.text(this.w - this.bordersize, this.suppliesy, this.game.blankets).attr({font:this.textsize+'px Arial', 'text-anchor':'end'});
				this.suppliesy = this.suppliesy+this.textsize*1.3+this.bordersize;
				
				this.r.text(this.bordersize, this.suppliesy, 'Dogs:').attr({font:this.textsize+'px Arial', 'text-anchor':'start'});
				this.dogsout = this.r.text(this.w - this.bordersize, this.suppliesy, this.game.dogs).attr({font:this.textsize+'px Arial', 'text-anchor':'end'});
				this.suppliesy = this.suppliesy+this.textsize*1.3+this.bordersize;
				
				this.r.text(this.bordersize, this.suppliesy, 'Weapons:').attr({font:this.textsize+'px Arial', 'text-anchor':'start'});
				this.weaponsout = this.r.text(this.w - this.bordersize, this.suppliesy, this.game.weapons).attr({font:this.textsize+'px Arial', 'text-anchor':'end'});
				this.suppliesy = this.suppliesy+this.textsize*1.3+this.bordersize;
			}, 
			journey: function(){
				if (!('journeyy' in this)){
					this.journeyy = this.suppliesy + this.textsize;
				
					this.r.text(this.bordersize, this.journeyy, 'Days:').attr({font:this.textsize+'px Arial', 'text-anchor':'start'});
					this.daysout = this.r.text(this.w - this.bordersize, this.journeyy, this.game.days).attr({font:this.textsize+'px Arial', 'text-anchor':'end'});
					this.journeyy = this.journeyy+this.textsize*1.3+this.bordersize;
					
					this.r.text(this.bordersize, this.journeyy, 'Miles:').attr({font:this.textsize+'px Arial', 'text-anchor':'start'});
					this.milesout = this.r.text(this.w - this.bordersize, this.journeyy, this.game.miles).attr({font:this.textsize+'px Arial', 'text-anchor':'end'});
				}
			},
			update: function(){
				this.foodout.attr({text: this.game.food});
				this.weightout.attr({text: this.game.weight});
				this.blanketsout.attr({text: this.game.blankets});
				this.dogsout.attr({text: this.game.dogs});
				this.weaponsout.attr({text: this.game.weapons});
				if ('daysout' in this){
					this.daysout.attr({text: this.game.days});
					this.milesout.attr({opacity:0});
					this.milesout = this.r.text(this.w - this.bordersize, this.journeyy, this.game.miles).attr({font:this.textsize+'px Arial', 'text-anchor':'end'});
				}
			}
		});
		
		dojo.declare( "button", null, {
			constructor: function(args){
				dojo.mixin(this, args);
				this.texto = 1;
				this.backo = .9;
				this.toosoon = false;
				this.validtoclick = true;
				this.make();
			},
			make: function(){
				if (this.det == 'text'){ //size of the button is to be determined by the text size
					var self = this;
					this.text = this.r.text(this.x, this.y, this.t).attr({font: this.s +'px Arial', opacity:this.texto});
					
					var w = this.text.getBBox().width*1.2;
					var h = this.text.getBBox().height*1.1;
					this.back = this.r.rect(this.x - w/2, this.y - h/2, w, h,4).attr({'stroke-width':5, fill:'#fff', opacity:this.backo});
					
					this.text.toFront();					
					
					this.text.click(dojo.hitch(self,self.clicked));
					this.back.click(dojo.hitch(self,self.clicked));
				}
				if (this.det == 'size'){ //size of the button is to be determined by the text size
					var self = this;
					this.back = this.r.rect(this.x, this.y, this.w, this.h,4);
					this.back.attr({'stroke-width':5, fill:'#fff', opacity:this.backo});
					this.size = this.back.getBBox().height*(1/1.1);
					this.text = this.r.text(this.x+this.w/2, this.y+this.h/2, this.t).attr({font: this.size+'px Arial', opacity: this.texto});
					if (this.text.getBBox().width > this.w){
						var tw = this.text.getBBox().width;
						var wlimit = this.w*(1/1.2);
						if (tw/wlimit < 15000){
							this.text.attr({font: wlimit*this.size/tw+'px Arial'});
							this.size = wlimit*this.size/tw;
						}
						if (this.text.getBBox().height > this.h){
							var th = this.text.getBBox().height;
							var hlimit = this.h*(1/1.1);
							if (th/hlimit < 150000){
								this.text.attr({font: hlimit*this.size/th+'px Arial'});
								this.size = hlimit*this.size/th;
							}
						}
					}
					if (this.text.getBBox().height > this.h){
						var th = this.text.getBBox().height;
						var hlimit = this.h*(1/1.1);
						if (th/hlimit < 150000){
							this.text.attr({font: hlimit*this.size/th+'px Arial'});
							this.size = hlimit*this.size/th;
						}
						if (this.text.getBBox().width > this.w){
							var tw = this.text.getBBox().width;
							var wlimit = this.w*(1/1.2);
							if (tw/wlimit < 1500000){
								this.text.attr({font: wlimit*this.size/tw+'px Arial'});
								this.size = wlimit*this.size/tw;
							}
						}
					}
					this.text.toFront();					
					
					this.text.click(dojo.hitch(self, self.clicked));
					this.back.click(dojo.hitch(self, self.clicked));
				}
			},
			clicked: function(){
				console.log('well clicked was called');
				if (this.toosoon == false && this.validtoclick == true){
					this.f();
					this.tooson == true;
					setTimeout(function(){
						this.toosoon = false;
					}, 50);
				}
			},
			hide: function(){
				this.text.attr({opacity: 0});
				this.back.attr({opacity: 0});
				this.validtoclick = false;
			},
			show: function(){
				this.back.attr({opacity: this.backo}).toFront();
				this.text.attr({opacity: this.texto}).toFront();
				this.validtoclick = true;
			},
			setf: function(f){
				this.f = f;
			},
			remove: function(){
				this.validtoclick = false;
				this.back.remove();
				this.text.remove();
			}
		});
				
		
		dojo.declare("team", null, {
			constructor: function(args){
				dojo.mixin(this, args);
				this.members = [];
				this.alive = 4;
			},
			setup: function(){
				var doc = new person({name: 'Sir Arthur Cromwell', type: 'Doctor', text: "SIR ARTHUR CROMWELL\n\n"+
																						 "A descendant of Oliver Cromwell who ruled England\n"+ 
																		                 "with an Iron Fist and became fairly unpopular. To\n"+
																						 "remedy his family image, Sir Arthur Cromwell is \n"+
																						 "striving to explore Antarctica for medical research.\n"+
																						 "Although a brilliant doctor of medicine, he tends\n" +
																						 "to be naïve in his own thinking. He can be overly-ambitious\n"+ 
																						 "and blinded by his own quest for glory, causing him to\n" +
																						 "pay little heed to those around him at times. Regardless…\n" +
																						 "like his family line, he is a leader and very adventurous.", sturdy: 1});
				var dogs = new person({name: 'Lorraine Kaplan', type: 'Dog Expert', text: "LORRAINE KAPLAN\n\n"+
																						  "Coming from her idyllic upbringing in rural South Dakota, \n"+
																						  "her innate connection to animals and ambition to see the \n"+
																						  "world make her a world-famous dog expert. Her specialty is \n"+
																						  "raising and training sled dogs. She is known for her greatly \n"+
																						  "optimistic character, but her loquacious nature can sometimes \n"+
																						  "become abrasive.", sturdy: 2});
				var sold = new person({name: 'Oscar Zimmermann', type: 'Soldier', text: "OSCAR ZIMMERMANN\n\n"+ 
																						"Born of German parents. His father Hludwig was an old \n"+
																						"military type. Oscar tries to follow in his father’s \n"+
																						"footsteps and live up to his father’s superior military \n"+
																						"status. He has volunteered for the Antarctic expedition \n"+
																						"during a time of peace to make his father proud. Oscar \n"+
																						"is a very promising and capable soldier, but inexperienced \n"+
																						"in actual war.", sturdy: 4});
				var expl = new person({name: 'Leon Chevalier', type: 'Explorer', text: "LEON CHEVALIER\n\n"+
																					   "Hailing from the Rhone-Aples region of France. \n"+
																					   "From the early age of 7, Leon became an accomplished \n"+
																					   "hunter. He won many awards growing up and has used \n"+
																					   "his expert hunting skills, extensive knowledge of \n"+
																					   "nature, and love for the outdoors to become an \n"+
																					   "experienced explorer. He boasts having explored \n"+
																					   "over 100 countries, although his rather presumptuous \n"+
																					   "character makes one question the validity of his claims.", sturdy: 3});
				this.poss = [expl, dogs, doc, sold];
			},
			starve: function(){
				dojo.forEach(this.members, function(m){
					if (!m.dead){
						m.starve();
					}
				});
			},
			getspeedfactor: function(){
				var sum = 0;
				for (var i = 0; i < 4; i++){
					sum = sum+ this.members[i].health;
				}
				return sum/(4*75);
			},
			getRandom: function(){
				var p = unc.random.choice(this.members);
				if (p.dead == false){
					return p;
				}
				else {
					return this.getRandom();
				}
			},
			add: function(pers){
				var newperson = new person(pers.args);
				this.members.push(newperson);
				this.sidebar.add(newperson);
				if (this.members.length ==4){
					this.game.supplies();
				}
				this.victim = unc.random.choice(this.members);
			},
			getVictim: function(){
				return this.victim;
			},
			killVictim: function(){
				this.victim.health = 0;
			},
			makeVictim: function(){
				this.victim = unc.random.choice(this.members);
				while (this.victim.dead == true){
					this.victim = unc.random.choice(this.members);
				}
			},
			hastype: function(type){
				var val = false;
				dojo.forEach(this.members, function(m){
					if (m.type == type && m.dead == false){
						val = true;
					}
				});
				return val;
			},
			updateout: function(){
				dojo.forEach(g.team.members, function(m){
					m.updatestat();
				});
			},
			improvehealth: function(){
				dojo.forEach(g.team.members, function(m){
					if (!m.dead){
						m.health = m.health + Math.random()*(30 + m.sturdy);
						m.updatestat();
					}
				});
			}
		});
		
		dojo.declare("person", null, {
			constructor: function(args){
				this.args = args;
				this.state = 'cold';
				this.health = 100;
				this.dead = false;
				dojo.mixin(this, args);
			},
			starve: function(){
				this.health = this.health - Math.random()*(18 - this.sturdy);
			},
			updatestat: function(){
				if (this.dead == false){
					if (this.health < 60){
						this.statout.attr({text:'Tired'});
					}
					if (this.health < 30){
						this.statout.attr({text:'Dying'});
					}
					if (this.health <= 0){
						this.health = 0;
						this.statout.attr({text:'Dead'});
						g.q.push(this);
					}
				}
			},
			die: function(){
				if (this.dead == false){
					this.dead = true;
					g.vis.cleartemp();
					g.vis.central("The journey has overcome "+this.name+"\n and you watch your "+this.type+" collapse to\n the ground. You have lost this team member.");
					this.state = "Dead";
					this.statout.attr({text:'Dead'});
					g.team.alive = g.team.alive - 1;
					if (g.team.alive == 0){
						g.lose();
					}
				}
			}
		});
		
		
		dojo.declare("eventbox", null, {
			constructor: function(args){
				dojo.mixin(this, args); 
				this.events = [];
			},
			setup: function(){
				this.createBasicEvent(1, function(){return "You get a break from the icy wind chill today. It does not feel so cold today."}, 'basic1STANDIN.jpg', function(){
					return true;
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor*.8;
					g.miles += g.speed*1.1;
				});
				this.createBasicEvent(1, function(){return "Your "+g.team.getVictim().name+", "+g.team.getVictim().name+", is suffering from photokeratitis. This is otherwise known as snow blindness and caused by overexposure to the UV rays from the sun. You remind your team to keep their snow goggles on at all times and "+g.team.getVictim().name+" begins to slow you down.."}, 'basic1STANDIN.jpg', function(){
					return true;
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor;
					g.miles += g.speed*.3;
				});
				this.createBasicEvent(1, function(){return "The clouds covering the sun today actually make visibility a bit better."}, 'basic1STANDIN.jpg', function(){
					return true;
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor;
					g.miles += g.speed*1.2;
				});
				this.createBasicEvent(1, function(){return "Your team is in high spirits and bonding well along the way."}, 'basic1STANDIN.jpg', function(){
					return true;
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor;
					g.miles += g.speed*1.2;
				});
				this.createBasicEvent(1, function(){return "Cheerful conversation between your team members is making the journey feel faster.."}, 'basic1STANDIN.jpg', function(){
					return true;
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor;
					g.miles += g.speed*1.2;
				});
				this.createBasicEvent(1, function(){return "There is some light snowfall, but it does not effect your travel."}, 'basic1STANDIN.jpg', function(){
					return true;
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor*1.1;
					g.miles += g.speed;
				});
				this.createBasicEvent(1, function(){return "Nothing of note happened today."}, 'basic1STANDIN.jpg', function(){
					return true;
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor;
					g.miles += g.speed;
				});
				this.createBasicEvent(1, function(){return "The terrain was rough today.\nYou made little progress."}, 'basic1STANDIN.jpg', function(){
					return true;
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor;
					g.miles += g.speed/2;
				});
				this.createBasicEvent(1, function(){return "It was warmer today, so you\n made extra progress."}, 'basic1STANDIN.jpg', function(){
					return true;
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor;
					g.miles += g.speed*1.5;
				});
				this.createBasicEvent(1, function(){return "You realize that you have\nbeen going the wrong way.\nYou backtrack and lose time."}, 'impassable.jpg', function(){
					return true;
				}, function(){
					g.days += 4;
					g.food = g.food - g.eatfactor*4;
				});
				this.createBasicEvent(1, function(){return "Your explorer found a shortcut!\nYou gain 20 miles!\nGood thing you brought that explorer."}, 'basic1STANDIN.jpg', function(){
					if (g.team.hastype('Explorer')){
						return true;
					}
					return false
				}, function(){
					g.days += 1;
					g.food = g.food - g.eatfactor;
					g.miles = g.miles + 20;
				});
				this.createBasicEvent(1, function(){return "Your soldier disappears for a\n"+"while and returns with a bird.\n"+"Creepy, but you gain food!"}, 'basic1STANDIN.jpg', function(){
					if (g.team.hastype('Soldier')){
						return true;
					}
					return false
				}, function(){
					g.food += 20;
					g.days += 1;
					g.food = g.food - g.eatfactor;
				});
				this.createBasicEvent(1, function(){return "Your dogs got in a fight, and\none was killed.  If only you\nhad had a dog expert around."}, 'basic1STANDIN.jpg', function(){
					//console.log('I am considering the dog fight');
					if (g.team.hastype('Dog Expert')){
						//console.log('i am rejecting the dog fight becuase there is a dog expert');
						return false;
					}
					return g.dogs >= 2;
				}, function(){
					g.dogs -= 1;
					g.days += 1;
					g.food = g.food - g.eatfactor;
				});
				
				this.someComplexEvents();
				this.createMiniGameEvents();
				this.prevevent = unc.random.choice(this.events);
			},
			createMiniGameEvents: function(){
				this.createBasicEvent(.3, function(){return g.team.victim.name+', your '+g.team.victim.type+',\nhas fallen into a crevasse.'}, 'crevasse.jpg',
					function(){
						return g.team.victim.dead == false;
					},
					function(){
						g.vis.next.setf(function(){
							g.vis.next.hide();
							g.vis.cleartemp();
							var f = function(mess, resultfunction){
								crevassegame.remove();
								g.vis.next.show();
								g.vis.next.setf(dojo.hitch(g, function(){
									dojo.hitch(g, g.step);
									g.vis.next.setf(dojo.hitch(g,g.step));
								}));
								g.vis.central(mess);
								resultfunction();
							}
							var crevassegame = new crevasse( g.vis.k.sidebarw, 0, g.vis.k.w - g.vis.k.sidebarw, g.vis.k.h, f);
						});
					});
			},
			createBasicEvent: function(prob, message, image, prereq, func){
				var o = new outcome({message: message, imagename: image, prob:1, effect: func});	
				var e = new eevent({canhappen: prereq, prob: prob, result: o, choices: []});
				this.events.push(e);
			},
			someComplexEvents: function(){
				var gb = new outcome({message: function(){return 'You choose to keep going,\n'+ "but a blizzard did come.\n" +'Your team was severely weakened!'}, imagename:'basic1STANDIN.jpg', prob:.5, effect: function(){
					g.team.starve();
					g.team.starve();
					g.team.starve();
					g.miles += g.speed;
					g.days += 5;
					g.food -= g.eatfactor*5;
				}});
				var gn = new outcome({message: function(){return 'You choose to keep going,\n'+'and no blizzard came.\n'+' Good call!'}, imagename:'basic1STANDIN.jpg', prob:.5, effect: function(){
					g.miles += g.speed;
					g.days += 1;
					g.food -= g.eatfactor;
				}});
				var sb = new outcome({message: function(){return 'You choose to set up shelter,\n'+'and a blizzard did come.\n'+' Good call!'}, imagename:'basic1STANDIN.jpg', prob:.5, effect: function(){
					g.miles += 0;
					g.days += 5;
					g.food -= g.eatfactor*5;
				}});
				var sn = new outcome({message: function(){return 'You choose to set up shelter,\n'+'but no blizzard came.\n'+'You lost time and food for nothing!'}, imagename:'basic1STANDIN.jpg', prob:.5, effect: function(){
					g.miles += 0;
					g.days += 2;
					g.food -= g.eatfactor*2;
				}});
				var gchoice = new choice( {canhappen: function(){return true}, message: 'Keep going', outcomes: [gb, gn]} );
				var schoice = new choice( {canhappen: function(){return true}, message: 'Make shelter', outcomes: [sb, sn]} );
				var blizzardevent = new eevent( {prob: 1, imagename:'blizz.jpg', message: function(){return 'You made good progress today, but\nyou think a blizzard may be coming.'}, canhappen:function(){return true;}, choices:[gchoice, schoice] });
				this.events.push(blizzardevent);
				
				var toasty = new outcome({message: function(){return 'You spend a night getting\nwarm. The health of your\nteam improved.\nGood thing you had blankets!'}, imagename:'basic1STANDIN.jpg', prob:.5, effect: function(){
					g.team.improvehealth();
					g.days += 2;
					g.food -= g.eatfactor*2;
				}});
				var moveoncold = new outcome({message: function(){return 'You keep going anyway.\nUnfortunately, the cold\ndoes not let up and your\nteam is weakened.'}, imagename:'basic1STANDIN.jpg', prob:.5, effect: function(){
					g.team.starve();
					g.miles += g.speed*2;
					g.days += 2;
					g.food -= g.eatfactor*2;
				}});
				var moveonwarm = new outcome({message: function(){return 'You keep going anyway.\nLuckily, it warms up a\nlittle and you are okay.'}, imagename:'basic1STANDIN.jpg', prob:.5, effect: function(){
					g.miles += g.speed*2;
					g.days += 2;
					g.food -= g.eatfactor*2;
				}});
				var gchoice = new choice( {canhappen: function(){return g.blankets >= g.team.alive}, message: 'Use blankets to get warm', outcomes: [toasty]} );
				var schoice = new choice( {canhappen: function(){return true}, message: 'Keep moving anyway', outcomes: [moveoncold, moveonwarm]} );
				var coldfrontevent = new eevent( {prob: 1, imagename:'basic1STANDIN.jpg', message: function(){return 'It has been bitterly cold for a week.\nYour are worried about frostbite.'}, canhappen:function(){return g.days > 10;}, choices:[gchoice, schoice] });
				this.events.push(coldfrontevent);
				
				var rewarm = new outcome({message: function(){
						rewarm.dayswasted = Math.floor(3*Math.random())+1;
						return g.team.getVictim().name+' gets better after resting for '+rewarm.dayswasted+' days.';}, 
					imagename: 'basic1STANDIN.jpg', prob: .5, effect: function(){
						g.days += rewarm.dayswasted;
						g.food -= rewarm.dayswasted*g.eatfactor;
					}
					});
				var hedie = new outcome({message: function(){
						return g.team.getVictim().name+' can only slow you down.  After '+Math.floor(3*Math.random())+' days, you no longer hear his screams in the distance.';}, 
					imagename: 'basic1STANDIN.jpg', prob: .5, effect: function(){
						g.team.killVictim();
					}})
				var o1 = new choice({canhappen: function(){return g.blankets > 0}, message: 'Rewarm using a blanket', outcomes: [rewarm]});
				var o2 = new choice({canhappen: function(){return g.blankets > 0}, message: 'Leave behind', outcomes: [hedie]});
				var frostbite = new eevent( { prob: .5, imagename:'basic1STANDIN.jpg', message:function(){return "Your "+g.team.getVictim().type+", "+g.team.getVictim().name+
																												 ", has developed frostbite. If the frostbite is allowed to "+
																												 "develop to deep frostbite, the area might become infected "+
																												 "with gangrene. This would result in amputation. To avoid "+
																												 "this, you must wrap "+g.team.getVictim().name+" in blankets "+
																												 "to rewarm the affected area."}, canhappen: function(){return g.days > 10}, choices: [o1, o2]});
				this.events.push(frostbite);																								
			},
			getNext: function(){
				var self = this;
				function tryone(){
					unc.random.shuffle(self.events);
					var i = Math.random();
					if (i < self.events[0].prob && self.events[0].canhappen() && self.prevevent != self.events[0]){
						return self.events[0];
					}
					else{
						return tryone();
					}
				}
				return tryone();
			}
		});
		
		dojo.declare("eevent", null, {
			constructor: function(args){
				dojo.mixin(this, args);  //need a probability, need an image and message, need a precondition function, and an array of choices
			},
			occur: function(){
				if (this.choices.length == 0){ //this event is really just an outcome
					//g.vis.displaynormal(this.message, this.imagename);
					this.result.occur();
				}
				if (this.choices.length > 0){
					var mess = this.message();
					g.vis.displaycomplex(mess, this.imagename, this.choices);
				}
			}
		});
		
		dojo.declare("choice", null, {
			constructor: function(args){ //needs a message function, a precondition function, and an array of outcomes
				dojo.mixin(this, args);
			},
			pick: function(){
				var result = unc.random.choice(this.outcomes);
				//display the message for the result
				result.occur();
			}
		});
		
		dojo.declare("outcome", null, {
			constructor: function(args){
				dojo.mixin(this, args);  //need a probability, need an occur(game) function, need an image and text
			},
			occur: function(){
				this.effect();
				var m = this.message();
				g.vis.displaynormal(m, this.imagename);
			}
		});
		
		dojo.ready(go);
	</script>
</head>

<body>

</body>